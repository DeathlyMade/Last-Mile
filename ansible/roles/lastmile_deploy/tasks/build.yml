---
- name: Ensure deployment directory exists
  file:
    path: "{{ playbook_dir }}/../k8s-deployment"
    state: directory

# ------------------------------------------------------------------
# 1. Generate Proto Descriptor (needed for Gateway)
# ------------------------------------------------------------------
- name: Generate Protos using Docker (bypass local node version issues)
  shell: |
    docker run --rm \
    -v "{{ playbook_dir }}/..:/workspace" \
    -w /workspace \
    node:18-bullseye \
    /bin/bash -c "apt-get update && apt-get install -y protobuf-compiler && cd frontend && npm install && cd .. && ./generate-proto.sh && chown -R $(id -u):$(id -g) frontend/src/proto proto.pb frontend/node_modules"
  args:
    chdir: "{{ playbook_dir }}/.." 

- name: Create ConfigMap for proto.pb
  shell: |
    if [ -f "proto.pb" ]; then
        kubectl create configmap proto-config --from-file=proto.pb=proto.pb --dry-run=client -o yaml | kubectl apply --validate=false -f -
    fi
  args:
    chdir: "{{ playbook_dir }}/.."

# ------------------------------------------------------------------
# 2. Build Docker Images (Targeting Minikube Docker Daemon)
# ------------------------------------------------------------------
- name: Build Backend Services
  shell: |
    eval $(minikube -p minikube docker-env)
    docker build -t lastmile/{{ item.name }}:latest -f {{ item.file }} backend/
  loop:
    - { name: 'station-service', file: 'backend/Dockerfile.station' }
    - { name: 'user-service', file: 'backend/Dockerfile.user' }
    - { name: 'driver-service', file: 'backend/Dockerfile.driver' }
    - { name: 'rider-service', file: 'backend/Dockerfile.rider' }
    - { name: 'location-service', file: 'backend/Dockerfile.location' }
    - { name: 'matching-service', file: 'backend/Dockerfile.matching' }
    - { name: 'trip-service', file: 'backend/Dockerfile.trip' }
    - { name: 'notification-service', file: 'backend/Dockerfile.notification' }
  args:
    chdir: "{{ playbook_dir }}/.."

- name: Build Redis Image
  shell: |
    eval $(minikube -p minikube docker-env)
    docker build -t lastmile/redis:latest backend/
  args:
    chdir: "{{ playbook_dir }}/.."

- name: Build Frontend Image
  shell: |
    eval $(minikube -p minikube docker-env)
    docker build -t lastmile/new-frontend:latest -f frontend/Dockerfile .
  args:
    chdir: "{{ playbook_dir }}/.."
