---
- name: Ensure deployment directory exists
  file:
    path: "{{ playbook_dir }}/../k8s-deployment"
    state: directory

# ------------------------------------------------------------------
# 1. Generate Proto Descriptor (needed for Gateway)
# ------------------------------------------------------------------
- name: Generate Protos using Docker (bypass local node version issues)
  shell: |
    docker run --rm \
    -v "{{ playbook_dir }}/..:/workspace" \
    -w /workspace \
    node:18-bullseye \
    /bin/bash -c "apt-get update && apt-get install -y protobuf-compiler && cd frontend && npm install && cd .. && ./generate-proto.sh && chown -R $(id -u):$(id -g) frontend/src/proto proto.pb frontend/node_modules"
  args:
    chdir: "/Users/daksh15/SPE/SPE_FINAL_PROJECT/Last-Mile"
  ignore_errors: yes 

- name: Create ConfigMap for proto.pb
  shell: |
    if [ -f "proto.pb" ]; then
        kubectl create configmap proto-config --from-file=proto.pb=proto.pb --dry-run=client -o yaml | kubectl apply --validate=false -f -
    fi
  args:
    chdir: "/Users/daksh15/SPE/SPE_FINAL_PROJECT/Last-Mile"

# ------------------------------------------------------------------
# 2. Build Docker Images (Targeting Minikube Docker Daemon)
# ------------------------------------------------------------------
- name: Build Backend Services
  shell: |
    export DOCKER_TLS_VERIFY=1
    export DOCKER_HOST="tcp://127.0.0.1:60496"
    export DOCKER_CERT_PATH="/tmp/certs"
    docker build -t lastmile/{{ item.name }}:latest -f {{ item.file }} backend/
  loop:
    - { name: 'station-service', file: 'backend/Dockerfile.station' }
    - { name: 'user-service', file: 'backend/Dockerfile.user' }
    - { name: 'driver-service', file: 'backend/Dockerfile.driver' }
    - { name: 'rider-service', file: 'backend/Dockerfile.rider' }
    - { name: 'location-service', file: 'backend/Dockerfile.location' }
    - { name: 'matching-service', file: 'backend/Dockerfile.matching' }
    - { name: 'trip-service', file: 'backend/Dockerfile.trip' }
    - { name: 'notification-service', file: 'backend/Dockerfile.notification' }
  args:
    chdir: "/Users/daksh15/SPE/SPE_FINAL_PROJECT/Last-Mile"

- name: Build Redis Image
  shell: |
    export DOCKER_TLS_VERIFY=1
    export DOCKER_HOST="tcp://127.0.0.1:60496"
    export DOCKER_CERT_PATH="/tmp/certs"
    docker build -t lastmile/redis:latest backend/
  args:
    chdir: "/Users/daksh15/SPE/SPE_FINAL_PROJECT/Last-Mile"

- name: Build Frontend Image
  shell: |
    export DOCKER_TLS_VERIFY=1
    export DOCKER_HOST="tcp://127.0.0.1:60496"
    export DOCKER_CERT_PATH="/tmp/certs"
    docker build -t lastmile/new-frontend:latest -f frontend/Dockerfile .
  args:
    chdir: "/Users/daksh15/SPE/SPE_FINAL_PROJECT/Last-Mile"
